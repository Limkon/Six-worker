var t={SUPER_PASSWORD:"771571215.",DEFAULT_PROXY_IP:"soho.perslist.com:443",SUB_HASH_LENGTH:6,IDLE_TIMEOUT_MS:45e3,MAX_CONCURRENT:512,XHTTP_BUFFER_SIZE:131072,ADDRESS_TYPE_IPV4:1,ADDRESS_TYPE_URL:2,ADDRESS_TYPE_IPV6:3,ATYP_TROJAN_DOMAIN:3,ATYP_TROJAN_IPV6:4,ATYP_SS_IPV4:1,ATYP_SS_DOMAIN:3,ATYP_SS_IPV6:4,SOCKS_VERSION:5,SOCKS_CMD_CONNECT:1,HTTP_PORTS:["80","8080","8880","2052","2082","2086","2095"],HTTPS_PORTS:["443","8443","2053","2083","2087","2096"],DEFAULT_GO2SOCKS5:["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"]},e=new TextDecoder,n=new TextEncoder,r=/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,s=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function a(t){return r.test(t)}async function o(t){const e=n.encode(t),r=await crypto.subtle.digest("SHA-1",e);return Array.from(new Uint8Array(r)).map(t=>t.toString(16).padStart(2,"0")).join("")}var i=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],c=(t,e)=>(t>>>e|t<<32-e)>>>0;function l(t){return(t=>{let e="";for(let n=0;n<t.length;n++)e+=(t[n]>>>4&15).toString(16),e+=(15&t[n]).toString(16);return e})((t=>{let e=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428];const n=8*t.length;for(t+=String.fromCharCode(128);8*t.length%512!=448;)t+=String.fromCharCode(0);const r=Math.floor(n/4294967296),s=4294967295&n;t+=String.fromCharCode(r>>>24&255,r>>>16&255,r>>>8&255,255&r,s>>>24&255,s>>>16&255,s>>>8&255,255&s);const a=[];for(let e=0;e<t.length;e+=4)a.push(t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3));const o=new Array(64);for(let t=0;t<a.length;t+=16){for(let e=0;e<16;e++)o[e]=a[t+e];for(let t=16;t<64;t++){const e=c(o[t-15],7)^c(o[t-15],18)^o[t-15]>>>3,n=c(o[t-2],17)^c(o[t-2],19)^o[t-2]>>>10;o[t]=o[t-16]+e+o[t-7]+n>>>0}let[n,r,s,l,d,u,p,h]=e;for(let t=0;t<64;t++){const e=h+(c(d,6)^c(d,11)^c(d,25))+(d&u^~d&p)+i[t]+o[t]>>>0,a=n&r^n&s^r&s;h=p,p=u,u=d,d=l+e>>>0,l=s,s=r,r=n,n=e+((c(n,2)^c(n,13)^c(n,22))+a>>>0)>>>0}e[0]=e[0]+n>>>0,e[1]=e[1]+r>>>0,e[2]=e[2]+s>>>0,e[3]=e[3]+l>>>0,e[4]=e[4]+d>>>0,e[5]=e[5]+u>>>0,e[6]=e[6]+p>>>0,e[7]=e[7]+h>>>0}return e.slice(0,7)})(unescape(encodeURIComponent(t))).flatMap(t=>[t>>>24&255,t>>>16&255,t>>>8&255,255&t]))}async function d(t){if(!t)return[];let e=t.replace(/[\t"'\r\n]+/g,",").replace(/,+/g,",");return e.startsWith(",")&&(e=e.slice(1)),e.endsWith(",")&&(e=e.slice(0,-1)),e.split(",").filter(Boolean)}function u(t){try{1!==t.readyState&&2!==t.readyState||t.close()}catch(t){}}var p=Array.from({length:256},(t,e)=>(e+256).toString(16).slice(1));async function h(t,e,n){const r=new Date(2007,6,7,n,0,0),s=864e5*e;async function a(t){const e=(new TextEncoder).encode(t),n=await crypto.subtle.digest("SHA-256",e),r=Array.from(new Uint8Array(n)).map(t=>t.toString(16).padStart(2,"0")).join("");return`${r.substr(0,8)}-${r.substr(8,4)}-4${r.substr(13,3)}-${(63&parseInt(r.substr(16,2),16)|128).toString(16)}${r.substr(18,2)}-${r.substr(20,12)}`}const o=function(){const t=new Date,e=new Date(t.getTime()+288e5),n=Number(e)-Number(r);return Math.ceil(n/s)}();return[await a(t+o),await a(t+(o-1))]}function f(t,e){return!(!e||0===e.length)&&e.some(e=>{let n=e.replace(/\*/g,".*");return new RegExp(`^${n}$`,"i").test(t)})}var m={},g={data:{},lastFetch:0},b={data:[],expires:0};function w(t){if(!t||!Array.isArray(t)||t.includes("REMOTE_CONFIG_URL"))return m={},g={data:{},lastFetch:0},void(b={data:[],expires:0});for(const e of t)delete m[e];t.includes("PROXYIP")&&(b={data:[],expires:0})}async function y(e,n,r=void 0){if(void 0!==m[n])return m[n];let s;if(e.KV){const t=await e.KV.get(n);null!==t&&(s=t)}!s&&g.data&&g.data[n]&&(s=g.data[n]),!s&&e[n]&&(s=e[n]),s||"UUID"!==n||(s=e.UUID||e.uuid||e.PASSWORD||e.pswd||e.SUPER_PASSWORD||t.SUPER_PASSWORD),s||"KEY"!==n||(s=e.KEY||e.TOKEN);const a=void 0!==s?s:r;return m[n]=a,a}async function S(e,n){const r=new URL(e?e.url:"http://localhost"),s=r.searchParams.has("flush");"1"===await y(n,"REMOTE_CONFIG","0")&&await async function(t,e=!1){const n=await t.KV.get("REMOTE_CONFIG_URL");if(!e&&g.data&&Object.keys(g.data).length>0)return g.data;if(n)try{const t=new AbortController,e=setTimeout(()=>t.abort(),5e3),r=await fetch(n,{signal:t.signal});if(clearTimeout(e),r.ok){const t=await r.text(),e=Date.now();try{const n=JSON.parse(t);g.data=n,g.lastFetch=e,m={}}catch(n){const r=t.split("\n"),s={};r.forEach(t=>{const e=t.trim();if(!e||e.startsWith("#")||e.startsWith("//"))return;const n=e.indexOf("=");if(n>0){const t=e.substring(0,n).trim(),r=e.substring(n+1).trim();t&&r&&(s[t]=r)}}),g.data=s,g.lastFetch=e,m={}}}}catch(t){}return g.data}(n,s);const[o,i,c,l,u,p,f,w,S,P,I]=await Promise.all([y(n,"ADMIN_PASS"),y(n,"UUID"),y(n,"KEY"),y(n,"TIME"),y(n,"UPTIME"),y(n,"PROXYIP"),y(n,"DNS64"),y(n,"SOCKS5"),y(n,"GO2SOCKS5"),y(n,"BAN"),y(n,"DIS","")]),x={userID:"",dynamicUUID:"",userIDLow:"",expectedUserIDs:[],proxyIP:"",proxyIPList:[],dns64:f||"",socks5:w||"",go2socks5:[],banHosts:[],enableXhttp:!1,disabledProtocols:[],httpsPorts:t.HTTPS_PORTS,startTime:Date.now(),adminPass:o};if(i&&(x.userID=i,x.dynamicUUID=i),c||i&&!a(i)){const t=c||i;if(t){const e=Number(l)||0,n=Number(u)||0,r=await h(t,e,n);x.userID=r[0],x.userIDLow=r[1],x.dynamicUUID=t}}if(!x.userID){const e=await y(n,"SUPER_PASSWORD")||t.SUPER_PASSWORD;if(e){const t=Number(l)||0,n=Number(u)||0,r=await h(e,t,n);x.userID=r[0],x.userIDLow=r[1],x.dynamicUUID=e}else{const t=crypto.randomUUID();x.userID=t,x.dynamicUUID=t}}x.expectedUserIDs=[x.userID,x.userIDLow].filter(Boolean).map(t=>t.toLowerCase());const D=p||t.DEFAULT_PROXY_IP;let U=[];if(D)if(D.startsWith("http"))if(Date.now()<b.expires)U=b.data;else try{const t=new AbortController,e=setTimeout(()=>t.abort(),5e3),n=await fetch(D,{signal:t.signal});if(clearTimeout(e),!n.ok)throw new Error(`ProxyIP fetch failed: ${n.status}`);{const t=await n.text(),e=await d(t);U=e,b.data=e,b.expires=Date.now()+6e5}}catch(e){const n=t.DEFAULT_PROXY_IP.split(/[,;\n]/).map(t=>t.trim()).filter(Boolean);U=n,b.data=n,b.expires=Date.now()+6e4}else U=D.split(/[,;\n]/).map(t=>t.trim()).filter(Boolean);if(U&&U.length>0){const t=U[Math.floor(Math.random()*U.length)];x.proxyIP=t,x.proxyIPList=[t]}else x.proxyIP="",x.proxyIPList=[];x.go2socks5=S?await d(S):t.DEFAULT_GO2SOCKS5,P&&(x.banHosts=await d(P));let T=I;if(T&&(T=T.replace(/，/g,",")),x.disabledProtocols=(await d(T)).map(t=>{const e=t.trim().toLowerCase();return"shadowsocks"===e?"ss":e}),x.enableXhttp=!x.disabledProtocols.includes("xhttp"),r.searchParams.has("proxyip")){const t=r.searchParams.get("proxyip");x.proxyIP=t,x.proxyIPList=[t]}return r.searchParams.has("socks5")&&(x.socks5=r.searchParams.get("socks5")),x}var P=new Map,I=(e,n,r)=>{const s=e instanceof Uint8Array?e:new Uint8Array(e);let a;if(r===t.ATYP_SS_DOMAIN){if(n>=s.length)return{hasError:!0,message:"Buffer too short for domain length"};a=s[n],n+=1}else if(r===t.ATYP_SS_IPV4)a=4;else{if(r!==t.ATYP_SS_IPV6)return{hasError:!0,message:"Invalid ATYP: "+r};a=16}const o=n+a;return o>s.length?{hasError:!0,message:"Buffer too short for address"}:{hasError:!1,targetAddrBytes:s.subarray(n,o),dataOffset:o}},x=new Map;import{connect as D}from"cloudflare:sockets";var U=new Map;function T(t){if(!t)return null;if((t=t.replace(/[\[\]]/g,"")).includes(".")){const e=t.lastIndexOf(":"),n=t.substring(e+1),r=t.substring(0,e),s=n.split(".").map(Number);if(4!==s.length)return null;const a=s[0]<<8|s[1],o=s[2]<<8|s[3],i=T(r+":0:0");return i?(i[6]=a,i[7]=o,i):null}const e=t.split(":");let n=[];const r=e.indexOf("");if(-1!==r){const t=e.slice(0,r).filter(t=>""!==t).map(t=>parseInt(t,16)||0),s=e.slice(r+1).filter(t=>""!==t).map(t=>parseInt(t,16)||0),a=new Array(8-t.length-s.length).fill(0);n=[...t,...a,...s]}else n=e.map(t=>parseInt(t,16)||0);return n.slice(0,8)}async function v(t,e){if(!e)return null;U.size>1e3&&U.clear();const n=`${t}|${e}`,r=U.get(n);if(r&&Date.now()<r.expires)return r.ip;let s=!1;try{const t=new URL(e);"http:"!==t.protocol&&"https:"!==t.protocol||(s=!0)}catch(t){}if(s){try{const r=new URL(e);r.searchParams.set("name",t),r.searchParams.set("type","AAAA");const s=await fetch(r.toString(),{method:"GET",headers:{Accept:"application/dns-json"}});if(!s.ok)return null;let a;try{a=await s.json()}catch(t){return null}if(a&&0===a.Status&&Array.isArray(a.Answer))for(const t of a.Answer)if(28===t.type&&t.data){const e=t.data;return U.set(n,{ip:e,expires:Date.now()+6e4}),e}}catch(t){}return null}let a=e.split("/")[0].trim();if(!a.includes(":"))return null;let o=t;if(!/^(\d{1,3}\.){3}\d{1,3}$/.test(t))try{const e=new URL("https://cloudflare-dns.com/dns-query");e.searchParams.set("name",t),e.searchParams.set("type","A");const n=await fetch(e,{headers:{Accept:"application/dns-json"}}),r=await n.json();if(!r||0!==r.Status||!Array.isArray(r.Answer))return null;{const t=r.Answer.find(t=>1===t.type);if(!t||!t.data)return null;o=t.data}}catch(t){return null}const i=o.split(".").map(Number);if(4===i.length){a.endsWith(":")||(a+=":");const t=`${a}${(i[0]<<8|i[1]).toString(16).padStart(4,"0")}:${(i[2]<<8|i[3]).toString(16).padStart(4,"0")}`;return U.set(n,{ip:t,expires:Date.now()+6e4}),t}return null}var A=new class{constructor(){this.cache=new Map}add(t){if(t&&!this.has(t)){if(this.cache.size>=500){const t=this.cache.keys().next().value;this.cache.delete(t)}this.cache.set(t,Date.now()+6e5)}}has(t){if(!t)return!1;const e=this.cache.get(t);return!(!e||Date.now()>e&&(this.cache.delete(t),1))}};function E(t){return t?Array.isArray(t)?0===t.length?null:t[Math.floor(Math.random()*t.length)]:t:null}function $(e,n){if(!e)return{host:t.DEFAULT_PROXY_IP.split(",")[0].trim(),port:n};let r=e,s=n;if(r.startsWith("[")){const t=r.indexOf("]");if(t>0){const e=r.substring(1,t),n=r.substring(t+1);if(n.startsWith(":")){const t=parseInt(n.substring(1),10);isNaN(t)||(s=t)}return{host:e,port:s}}}if((r.match(/:/g)||[]).length>1)return{host:r,port:s};const a=r.lastIndexOf(":");if(a>0){const t=r.substring(a+1);/^\d+$/.test(t)&&(s=parseInt(t,10),r=r.substring(0,a))}return{host:r,port:s}}function k(t,e){return!(!e||0===e.length)&&(!(!e.includes("all in")&&!e.includes("*"))||e.some(e=>{let n=e.replace(/\*/g,".*");return new RegExp(`^${n}$`,"i").test(t)}))}async function C(e,n,r,s,a,o=!1){const i=function(t){if(!t)return null;const e=t.includes("://")?t.split("://")[1]:t,n=e.lastIndexOf("@");let r,s,a,o,[i,c]=-1===n?[e,void 0]:[e.substring(n+1),e.substring(0,n)];if(c){const t=c.split(":");if(2!==t.length)throw new Error("Invalid SOCKS auth format");[r,s]=t}const l=i.lastIndexOf(":");if(-1===l)throw new Error("Invalid SOCKS address format, missing port");return a=i.substring(0,l),o=Number(i.substring(l+1)),a.startsWith("[")&&a.endsWith("]")&&(a=a.slice(1,-1)),{username:r,password:s,hostname:a,port:o}}(e);if(!i)throw new Error("Socks5 config missing");const{username:c,password:l,hostname:d,port:u}=i,p=D({hostname:d,port:u});await p.opened;const h=p.writable.getWriter(),f=p.readable.getReader(),m=new TextEncoder;await h.write(new Uint8Array([5,1,2]));let g,{value:b}=await f.read();if(!b||b.length<2||5!==b[0]||255===b[1])throw new Error("SOCKS5 greeting failed");if(2===b[1]){if(!c||!l)throw new Error("SOCKS5 auth required");const t=m.encode(c),e=m.encode(l),n=new Uint8Array([1,t.length,...t,e.length,...e]);await h.write(n);const{value:r}=await f.read();if(!r||r.length<2||1!==r[0]||0!==r[1])throw new Error("SOCKS5 auth failed")}switch(n){case t.ADDRESS_TYPE_IPV4:g=new Uint8Array([1,...r.split(".").map(Number)]);break;case t.ADDRESS_TYPE_IPV6:case t.ATYP_TROJAN_IPV6:const e=T(r.replace(/[\[\]]/g,""));if(!e)throw new Error("Invalid IPv6 address");const n=new Uint8Array(16);for(let t=0;t<8;t++)n[2*t]=e[t]>>8&255,n[2*t+1]=255&e[t];g=new Uint8Array([4,...n]);break;default:const s=m.encode(r);g=new Uint8Array([3,s.length,...s])}const w=o?3:1,y=new Uint8Array([5,w,0,...g,s>>8,255&s]);await h.write(y);const{value:S}=await f.read();if(!S||S.length<2||5!==S[0]||0!==S[1])throw new Error(`SOCKS5 connection failed (CMD: ${w})`);let P=0;return S.length>=4&&(1===S[3]?P=10:4===S[3]?P=22:3===S[3]&&(P=7+S[4])),P>0&&S.length>P&&(p.initialData=S.subarray(P)),h.releaseLock(),f.releaseLock(),p}async function R(t,e,n,r,s=null,a=null,o=null,i=!1){let c=!1,l=null;const d=new Promise((t,e)=>setTimeout(()=>{c=!0,e(new Error(`Connect timeout (${n}ms)`))},n)),u=async()=>{let n;try{if(n=s?await C(s,a,o,e,0,i):D({hostname:t,port:e}),c){if(n)try{n.close()}catch(t){}return null}return n}catch(t){throw t}};try{if(l=await Promise.race([u(),d]),c){if(l)try{l.close()}catch(t){}throw new Error(`Connect timeout (${n}ms)`)}if(!l)throw new Error("Connection failed or aborted");return s||await Promise.race([l.opened,d]),l}catch(t){if(l)try{l.close()}catch(t){}throw t}}async function L(e,n,r,s,a,o,i=!1){const c=e.socks5&&k(n,e.go2socks5),l=[1500,4e3];if(A.has(n))a(`[Smart] Skipping Phase 1 (Direct) for cached failed host: ${n}`);else{const t=l[0];try{return a(`[connect:${i?"UDP":"TCP"}] Phase 1: Direct ${n}:${r} (Timeout: ${t}ms)`),await R(n,r,t,0,c?e.socks5:null,s,n,i)}catch(t){a(`[connect] Phase 1 failed: ${t.message}`),(t.message.includes("refused")||t.message.includes("reset")||t.message.includes("abort"))&&(a(`[Smart] Adding ${n} to failure cache (Circuit Breaker)`),(d=n)&&A.add(d))}}var d;let u=E(o||e.proxyIP);if(!u){const e=t.DEFAULT_PROXY_IP.split(/[,;\n]/).map(t=>t.trim()).filter(Boolean);e.length>0&&(u=e[0])}if(u){const{host:t,port:e}=$(u,r);try{return await R(t.toLowerCase(),e,5e3)}catch(e){a(`[connect] Phase 2 (ProxyIP: ${t}) failed: ${e.message}`)}}if(!c&&e.dns64)try{a("[connect] Phase 3: Attempting NAT64...");const t=await v(n,e.dns64);if(t)return await R(t,r,5e3);a("[connect] Phase 3 (NAT64) skipped: DNS resolution failed")}catch(t){a(`[connect] Phase 3 (NAT64) failed: ${t.message}`)}throw new Error("All connection attempts failed.")}async function O(t,e,n,r,s){let a=!1,o=n;const i=t=>{try{if(1===e.readyState)return e.send(t),!0}catch(t){s(`[WS] Send Error: ${t.message}`)}return!1};if(t.initialData&&t.initialData.byteLength>0){if(a=!0,s(`[Socks5] Flushing ${t.initialData.byteLength} bytes of early data`),o){const e=o,n=t.initialData,r=new Uint8Array(e.length+n.length);if(r.set(e),r.set(n,e.length),!i(r))return;o=null}else if(!i(t.initialData))return;t.initialData=null}if(await t.readable.pipeTo(new WritableStream({async write(t,n){if(a=!0,1===e.readyState){if(o){const e=o,r=t instanceof Uint8Array?t:new Uint8Array(t),s=new Uint8Array(e.length+r.length);if(s.set(e),s.set(r,e.length),!i(s))return void n.error(new Error("WebSocket send failed"));o=null}else if(!i(t))return void n.error(new Error("WebSocket send failed"))}else n.error(new Error("Client WebSocket closed, stopping remote read"))},close(){s(`Remote socket closed. Data: ${a}`)},abort(t){}})).catch(t=>{"webSocket is not open"!==t.message&&t.message,u(e)}),!a&&r){s("Retry initiated due to no data");try{await r()}catch(t){s("Retry failed",t),u(e)}}}async function _(t,e){const n=new Promise((t,e)=>setTimeout(()=>e(new Error("Write timeout")),1e4));await Promise.race([t.write(e),n])}async function B(t,e,n){if(!e||0===e.length)return;n(`Flushing ${e.length} buffered chunks`);let r=0;for(;e.length>0;){if(r>=20){n("[Warn] Buffer flush limit reached.");break}const s=[...e];e.length=0;for(const e of s)try{await _(t,e)}catch(t){throw n(`[Error] Write failed during flush: ${t.message}`),t}r++}}var N=(new class{constructor(){this.handlers=[]}register(t,e){return this.handlers.push({name:t,validator:e}),this}async detect(t,e){const n=[e.userID];e.userIDLow&&n.push(e.userIDLow);const r=e.dynamicUUID;for(const e of this.handlers)try{let s=null;"vless"===e.name?s=n:"trojan"!==e.name&&"mandala"!==e.name||(s=r);const a=await e.validator(t,s);if(!a.hasError)return{...a,protocol:e.name}}catch(t){}throw new Error("Protocol detection failed.")}}).register("vless",async function(n,r){if(n.byteLength<24)return{hasError:!0,message:"Buffer too short"};const o=n instanceof Uint8Array?n:new Uint8Array(n),i=o[0];if(0!==i)return{hasError:!0,message:"Invalid VLESS version"};const c=function(t,e=0){const n=(p[t[e+0]]+p[t[e+1]]+p[t[e+2]]+p[t[e+3]]+"-"+p[t[e+4]]+p[t[e+5]]+"-"+p[t[e+6]]+p[t[e+7]]+"-"+p[t[e+8]]+p[t[e+9]]+"-"+p[t[e+10]]+p[t[e+11]]+p[t[e+12]]+p[t[e+13]]+p[t[e+14]]+p[t[e+15]]).toLowerCase();if(!function(t){return a(t)||s.test(t)}(n))throw TypeError("Invalid stringified UUID");return n}(o.subarray(1,17));if(!r.includes(c))return{hasError:!0,message:"Invalid VLESS user"};const l=18+o[17];if(l>=o.byteLength)return{hasError:!0,message:"Buffer too short for command"};const d=o[l],u=2===d;if(1!==d&&2!==d)return{hasError:!0,message:"Unsupported VLESS command: "+d};const h=l+1;if(o.byteLength<h+2)return{hasError:!0,message:"Buffer too short for port"};const f=new DataView(o.buffer,o.byteOffset,o.byteLength).getUint16(h,!1);let m=h+2;const g=o[m];m++;let b="",w=0;try{switch(g){case t.ADDRESS_TYPE_IPV4:w=4,b=o.subarray(m,m+4).join(".");break;case t.ADDRESS_TYPE_URL:w=o[m],m++,b=e.decode(o.subarray(m,m+w));break;case t.ADDRESS_TYPE_IPV6:w=16;const n=new DataView(o.buffer,o.byteOffset+m,16),r=[];for(let t=0;t<8;t++)r.push(n.getUint16(2*t,!1).toString(16));b="["+r.join(":")+"]";break;default:return{hasError:!0,message:"Invalid VLESS addressType: "+g}}}catch(t){return{hasError:!0,message:"Address parse failed"}}return b?{hasError:!1,addressRemote:b,addressType:g,portRemote:f,isUDP:u,rawDataIndex:m+w,cloudflareVersion:new Uint8Array([i])}:{hasError:!0,message:"VLESS address is empty"}}).register("trojan",async function(r,s){if(r.byteLength<58)return{hasError:!0,message:"Trojan buffer too short."};const a=r instanceof Uint8Array?r:new Uint8Array(r);let o=P.get(s);if(o)P.delete(s),P.set(s,o);else{const t=l(String(s));if(o=n.encode(t),P.size>=100){const t=P.keys().next().value;P.delete(t)}P.set(s,o)}if(!function(t,e){if(t.byteLength!==e.byteLength)return!1;let n=0;for(let r=0;r<t.byteLength;r++)n|=t[r]^e[r];return 0===n}(a.subarray(0,56),o))return{hasError:!0,message:"Invalid Trojan password."};if(13!==a[56]||10!==a[57])return{hasError:!0,message:"Invalid Trojan header (Missing CRLF)"};const i=a.subarray(58);if(i.byteLength<4)return{hasError:!0,message:"Trojan request too short."};const c=new DataView(i.buffer,i.byteOffset,i.byteLength),d=i[0],u=3===d;if(1!==d&&!u)return{hasError:!0,message:"Unsupported Trojan cmd: "+d};const p=i[1];let h,f,m=0;try{switch(p){case t.ADDRESS_TYPE_IPV4:m=6,h=i.subarray(2,m).join(".");break;case t.ATYP_TROJAN_DOMAIN:m=3+i[2],h=e.decode(i.subarray(3,m));break;case t.ATYP_TROJAN_IPV6:m=18;const n=[];for(let t=0;t<8;t++)n.push(c.getUint16(2+2*t,!1).toString(16));h="["+n.join(":")+"]";break;default:return{hasError:!0,message:"Invalid Trojan ATYP: "+p}}}catch(t){return{hasError:!0,message:"Address decode failed"}}if(m+2>i.byteLength)return{hasError:!0,message:"Buffer too short for port"};f=c.getUint16(m,!1);const g=m+2;return i.byteLength<g+2||13!==i[g]||10!==i[g+1]?{hasError:!0,message:"Trojan missing payload CRLF"}:{hasError:!1,addressRemote:h,addressType:p,portRemote:f,rawClientData:i.subarray(g+2),isUDP:u,rawDataIndex:0}}).register("mandala",async function(r,s){if(r.byteLength<67)return{hasError:!0,message:"Mandala buffer too short"};const a=r instanceof Uint8Array?r:new Uint8Array(r),o=a.subarray(0,4),i=new Uint8Array(a.byteLength-4),c=i.length;for(let t=0;t<c;t++)i[t]=a[t+4]^o[3&t];let d=x.get(s);if(d)x.delete(s),x.set(s,d);else{const t=l(String(s));if(d=n.encode(t),x.size>=100){const t=x.keys().next().value;x.delete(t)}x.set(s,d)}if(!function(t,e){if(t.byteLength!==e.byteLength)return!1;let n=0;for(let r=0;r<t.byteLength;r++)n|=t[r]^e[r];return 0===n}(i.subarray(0,56),d))return{hasError:!0,message:"Invalid Mandala Auth"};let u=57+i[56];if(u>=i.length)return{hasError:!0,message:"Buffer too short after padding"};const p=i[u],h=3===p;if(1!==p&&!h)return{hasError:!0,message:"Unsupported Mandala CMD: "+p};u++;const f=i[u],m=I(i,u+1,f);if(m.hasError)return m;const g=m.dataOffset;if(g+2>i.byteLength)return{hasError:!0,message:"Buffer short for port"};const b=new DataView(i.buffer,i.byteOffset,i.byteLength).getUint16(g,!1),w=g+2;if(w+2>i.byteLength)return{hasError:!0,message:"Missing CRLF data"};if(13!==i[w]||10!==i[w+1])return{hasError:!0,message:"Missing CRLF"};let y="";try{switch(f){case t.ADDRESS_TYPE_IPV4:y=m.targetAddrBytes.join(".");break;case t.ATYP_SS_DOMAIN:y=e.decode(m.targetAddrBytes);break;case t.ATYP_SS_IPV6:const n=[],r=new DataView(m.targetAddrBytes.buffer,m.targetAddrBytes.byteOffset,m.targetAddrBytes.byteLength);for(let t=0;t<8;t++)n.push(r.getUint16(2*t,!1).toString(16));y="["+n.join(":")+"]";break;default:return{hasError:!0,message:"Unknown ATYP"}}}catch(t){return{hasError:!0,message:"Address decode failed"}}return{hasError:!1,addressRemote:y,portRemote:b,addressType:f,isUDP:h,rawClientData:i.subarray(w+2),protocol:"mandala"}}).register("socks5",async function(n,r=0){const s=n instanceof Uint8Array?n:new Uint8Array(n),a=s.length;if(r||(r=0),r+4>a)return{hasError:!0,message:"SOCKS buffer too short."};if(s[r]!==t.SOCKS_VERSION)return{hasError:!0,message:"Invalid SOCKS version."};const o=s[r+1],i=3===o;if(o!==t.SOCKS_CMD_CONNECT&&!i)return{hasError:!0,message:"Unsupported SOCKS command: "+o};if(0!==s[r+2])return{hasError:!0,message:"Invalid SOCKS RSV."};const c=s[r+3],l=I(s,r+4,c);if(l.hasError)return l;if(l.dataOffset+2>a)return{hasError:!0,message:"SOCKS buffer too short for port"};const d=new DataView(s.buffer,s.byteOffset,s.byteLength).getUint16(l.dataOffset,!1);let u="";switch(c){case t.ADDRESS_TYPE_IPV4:u=l.targetAddrBytes.join(".");break;case t.ATYP_TROJAN_DOMAIN:u=e.decode(l.targetAddrBytes);break;case t.ATYP_TROJAN_IPV6:const n=[],r=new DataView(l.targetAddrBytes.buffer,l.targetAddrBytes.byteOffset,l.targetAddrBytes.byteLength);for(let t=0;t<8;t++)n.push(r.getUint16(2*t,!1).toString(16));u="["+n.join(":")+"]";break;default:return{hasError:!0,message:"Invalid SOCKS ATYP: "+c}}return{hasError:!1,addressRemote:u,addressType:c,portRemote:d,rawClientData:s.subarray(l.dataOffset+2),isUDP:i,rawDataIndex:0,isSocks5:!0}}).register("ss",async function(n){const r=n instanceof Uint8Array?n:new Uint8Array(n);if(r.byteLength<4)return{hasError:!0,message:"SS buffer too short"};const s=r[0],a=I(r,1,s);if(a.hasError)return a;if(a.dataOffset+2>r.byteLength)return{hasError:!0,message:"SS buffer too short for port"};const o=new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(a.dataOffset,!1);let i="";switch(s){case t.ATYP_SS_IPV4:i=a.targetAddrBytes.join(".");break;case t.ATYP_SS_DOMAIN:i=e.decode(a.targetAddrBytes);break;case t.ATYP_SS_IPV6:const n=[],r=new DataView(a.targetAddrBytes.buffer,a.targetAddrBytes.byteOffset,a.targetAddrBytes.byteLength);for(let t=0;t<8;t++)n.push(r.getUint16(2*t,!1).toString(16));i="["+n.join(":")+"]";break;default:return{hasError:!0,message:"Invalid SS ATYP: "+s}}return{hasError:!1,addressRemote:i,addressType:s,portRemote:o,rawClientData:r.subarray(a.dataOffset+2),isUDP:!1,rawDataIndex:0}});function V(t,e){const n=function(t){if(!t)return[];t=t.replaceAll("-","");const e=[];for(let n=0;n<16;n++)e.push(parseInt(t.substr(2*n,2),16));return e}(e);if(16!==n.length)return!1;for(let e=0;e<16;e++)if(t[e]!==n[e])return!1;return!0}function j(t,...e){let n=t.length;for(let t of e)n+=t.length;const r=new t.constructor(n);r.set(t,0),n=t.length;for(let t of e)r.set(t,n),n+=t.length;return r}async function M(t,e,n){let r=n||new Uint8Array(0);for(;r.length<e;){const n=e-r.length,s=Math.max(n,4096),{value:a,done:o}=await t.read(new Uint8Array(s));if(o)return{value:r,done:!0};a&&(r=j(r,a))}return{value:r,done:!1}}function H(e,n,r,s,a,o){let i=[];const c=[],l=t.HTTP_PORTS,d=o.httpsPorts,u="/?ed=2560",p=(t,s,a)=>{const o=a?d:l,p=s.match(/^(.*?)(?::(\d+))?(?:#(.*))?$/);if(!p)return;const h=p[1],f=p[2]||o[0],m=p[3]?`${t.toUpperCase()}-${p[3]}`:`${r}-${t.toUpperCase()}`;let g={name:m,type:"xhttp"===t?"vless":"ss"===t?"ss":"socks"===t?"socks5":t,server:h,port:parseInt(f),tls:a,"skip-cert-verify":!0,udp:!1};"vless"===t||"xhttp"===t?(g.uuid=e,g.cipher="auto"):"trojan"===t?g.password=n:"ss"===t?(g.cipher="none",g.password=n,g.plugin="v2ray-plugin",g["plugin-opts"]={mode:"websocket",tls:a,host:r,path:u},a&&(g["plugin-opts"].sni=r)):"socks"===t&&(g.username=e,g.password=n),"xhttp"===t?(g.network="xhttp",g["xhttp-opts"]={mode:"stream-one",path:"/"+e.substring(0,8),headers:{Host:r,"Content-Type":"application/grpc","User-Agent":"Go-http-client/2.0"}},g.servername=r):"ss"!==t&&(g.network="ws",g["ws-opts"]={path:u,headers:{Host:r}},a&&(g.servername=r)),i.push(g),c.push(m)};let h=["vless","trojan","ss","socks","xhttp"];return h=h.filter(t=>!(o.disabledProtocols.includes(t)||"socks"===t&&o.disabledProtocols.includes("socks5"))),o.addresses&&o.addresses.forEach(t=>{h.forEach(e=>{p(e,t,!0)})}),!s&&o.addressesnotls&&o.addressesnotls.forEach(t=>{h.forEach(e=>{"xhttp"!==e&&p(e,t,!1)})}),K(i,c)}function K(t,e){return`port: 7890\nallow-lan: true\nmode: rule\nlog-level: info\nproxies:\n${t.map(t=>{let e=`- name: ${t.name}\n  type: ${t.type}\n  server: ${t.server}\n  port: ${t.port}\n  tls: ${t.tls}\n  udp: ${t.udp}\n  skip-cert-verify: true\n`;return t.uuid&&(e+=`  uuid: ${t.uuid}\n`),t.password&&(e+=`  password: "${t.password}"\n`),t.username&&(e+=`  username: "${t.username}"\n`),t.cipher&&(e+=`  cipher: ${t.cipher}\n`),t.network&&(e+=`  network: ${t.network}\n`),t.servername&&(e+=`  servername: ${t.servername}\n`),t["ws-opts"]&&(e+=`  ws-opts:\n    path: "${t["ws-opts"].path}"\n    headers:\n      Host: ${t["ws-opts"].headers.Host}\n`),t["xhttp-opts"]&&(e+=`  xhttp-opts:\n    mode: ${t["xhttp-opts"].mode}\n    path: "${t["xhttp-opts"].path}"\n    headers:\n      Host: ${t["xhttp-opts"].headers.Host}\n      Content-Type: ${t["xhttp-opts"].headers["Content-Type"]}\n      User-Agent: ${t["xhttp-opts"].headers["User-Agent"]}\n`),t.plugin&&(e+=`  plugin: ${t.plugin}\n  plugin-opts:\n    mode: ${t["plugin-opts"].mode}\n    tls: ${t["plugin-opts"].tls}\n    host: ${t["plugin-opts"].host}\n    path: "${t["plugin-opts"].path}"\n`,t["plugin-opts"].sni&&(e+=`    sni: ${t["plugin-opts"].sni}\n`)),e}).join("")}\nproxy-groups:\n- name: 节点选择\n  type: select\n  proxies:\n  - 自动选择\n  - DIRECT\n${e.map(t=>`  - ${t}`).join("\n")}\n- name: 自动选择\n  type: url-test\n  url: http://www.gstatic.com/generate_204\n  interval: 300\n  proxies:\n${e.map(t=>`  - ${t}`).join("\n")}\nrules:\n- MATCH,节点选择`}function Y(e,n,r,s,a,o,i=null){let c=[];const l=t.HTTP_PORTS,d=o.httpsPorts,u=(t,s,a)=>{const o=a?d:l,i=s.match(/^(.*?)(?::(\d+))?(?:#(.*))?$/);if(!i)return;const u=i[1],p=i[2]||o[0],h=i[3]?`${t.toUpperCase()}-${i[3]}`:`${r}-${t.toUpperCase()}`;let f={type:"xhttp"===t?"vless":"ss"===t?"shadowsocks":"socks"===t?"socks5":t,tag:h,server:u,server_port:parseInt(p)};"vless"===t||"xhttp"===t?(f.uuid=e,f.packet_encoding="packetaddr"):"trojan"===t?f.password=n:"ss"===t?(f.method="none",f.password=n):"socks"===t&&(f.username=e,f.password=n),f.transport="xhttp"===t?{type:"xhttp",mode:"stream-one",path:"/"+e.substring(0,8),headers:{Host:r,"Content-Type":"application/grpc","User-Agent":"Go-http-client/2.0"}}:{type:"ws",path:"/?ed=2560",headers:{Host:r}},a&&(f.tls={enabled:!0,server_name:r,insecure:!0,utls:{enabled:!0,fingerprint:"chrome"}}),c.push(f)};let p=[];p=i||["vless","trojan","ss","socks","xhttp"].filter(t=>!(o.disabledProtocols.includes(t)||"socks"===t&&o.disabledProtocols.includes("socks5"))),o.addresses&&o.addresses.forEach(t=>{p.forEach(e=>{u(e,t,!0)})}),!s&&o.addressesnotls&&o.addressesnotls.forEach(t=>{p.forEach(e=>{"xhttp"!==e&&u(e,t,!1)})});const h=c.map(t=>t.tag);return JSON.stringify({log:{level:"info"},inbounds:[{type:"tun",tag:"tun-in"}],outbounds:[{type:"selector",tag:"select",outbounds:["auto","direct",...h]},{type:"urltest",tag:"auto",outbounds:h,url:"http://www.gstatic.com/generate_204"},{type:"direct",tag:"direct"},...c],route:{final:"select",rules:[{protocol:"dns",outbound:"direct"}]}},null,2)}async function W(t,e){if(!t)return[];try{const e=new AbortController,n=setTimeout(()=>e.abort(),5e3),r=await fetch(t,{signal:e.signal,headers:{"User-Agent":"Mozilla/5.0"}});if(clearTimeout(n),r.ok){const t=await r.text();return await d(t)}}catch(t){}return[]}async function F(t,e,n,r,s){if(!t)return[];try{const n=await fetch(t,{headers:{"User-Agent":"Mozilla/5.0"}});if(!n.ok)return[];const a=(await n.text()).split(/\r?\n/);if(0===a.length)return[];const o=a[0].split(",").indexOf("TLS");if(-1===o)return[];const i=[];for(let t=1;t<a.length;t++){const n=a[t].split(",");if(n.length>o&&n[o]&&n[o].toUpperCase()===(e?"TRUE":"FALSE")&&parseFloat(n[n.length-1])>r){const t=n[0],e=n[1],r=n[o+s]||"CSV";i.push(`${t}:${e}#${r}`)}}return i}catch(t){}return[]}async function X(e,n,r,s,a){const i=await y(n,"SUBNAME","sub");await async function(e,n){const r=await y(n,"ADD.txt")||await y(n,"ADD"),s=await y(n,"ADDAPI"),a=await y(n,"ADDNOTLS"),o=await y(n,"ADDNOTLSAPI"),i=await y(n,"ADDCSV"),c=await y(n,"LINK"),l=Number(await y(n,"DLS","8")),u=Number(await y(n,"CSVREMARK","1"));let p=[],h=[],f=[],m=[],g=[];r&&(await d(r)).forEach(t=>{t.startsWith("http")?f.push(t):p.push(t)}),s&&f.push(...await d(s)),a&&(h=await d(a)),o&&m.push(...await d(o)),i&&(g=await d(i));const b=await async function(e,n,r,s,a,o,i){const c="SUB_REMOTE_CACHE",l=async()=>{const l=await async function(e,n,r,s,a,o,i){let c=[],l=[];if(r.length>0&&(await Promise.all(r.map(t=>W(t,n.httpsPorts)))).forEach(t=>c.push(...t)),s.length>0&&(await Promise.all(s.map(e=>W(e,t.HTTP_PORTS)))).forEach(t=>l.push(...t)),a.length>0){const[t,e]=await Promise.all([Promise.all(a.map(t=>F(t,!0,n.httpsPorts,o,i))),Promise.all(a.map(t=>F(t,!1,n.httpsPorts,o,i)))]);t.forEach(t=>c.push(...t)),e.forEach(t=>l.push(...t))}return{addresses:c,addressesnotls:l}}(0,n,r,s,a,o,i),d={ts:Date.now(),data:l};return e.KV&&await e.KV.put(c,JSON.stringify(d)),l};let d=null;if(e.KV)try{const t=await e.KV.get(c);t&&(d=JSON.parse(t))}catch(t){}return d&&d.data?(Date.now()-d.ts>36e5&&n.waitUntil&&n.waitUntil(l().catch(t=>{})),d.data):await l()}(n,e,f,m,g,l,u);let w=c?await d(c):[];e.addresses=[...new Set([...p,...b.addresses])].filter(Boolean),e.addressesnotls=[...new Set([...h,...b.addressesnotls])].filter(Boolean),e.hardcodedLinks=w,0===e.addresses.length&&0===e.hardcodedLinks.length&&(e.addresses.push("www.visa.com.tw:443#CF-Default-1"),e.addresses.push("usa.visa.com:8443#CF-Default-2"))}(r,n);const c=t.SUB_HASH_LENGTH,l=t=>!("socks5"===t&&r.disabledProtocols.includes("socks")||r.disabledProtocols.includes(t)),u=["all","sub","all-tls","all-clash","all-clash-tls","all-sb","all-sb-tls","vless","vless-tls","vless-clash","vless-clash-tls","vless-sb","vless-sb-tls","trojan","trojan-tls","trojan-clash","trojan-clash-tls","trojan-sb","trojan-sb-tls","ss","ss-tls","ss-clash","ss-clash-tls","ss-sb","ss-sb-tls","socks","socks-tls","socks-clash","socks-clash-tls","socks-sb","socks-sb-tls","mandala-tls","xhttp-tls","xhttp-clash-tls","xhttp-sb-tls"],p=u.map(t=>o(t)),h=(await Promise.all(p)).map(t=>t.toLowerCase().substring(0,c)),f={};h.forEach((t,e)=>f[t]=u[e]);const m=s.toLowerCase().substring(0,c),g=f[m];if(!g)return null;const b={"Content-Type":"text/plain;charset=utf-8"},w={...b,"Content-Disposition":`attachment; filename="${i}"`},S={"Content-Type":"application/json;charset=utf-8"},P={...S,"Content-Disposition":`attachment; filename="${i}.json"`},I=(e,n)=>function(e,n,r,s,a,o=!1){let i=[];const c=t.HTTP_PORTS,l=a.httpsPorts,d="/?ed=2560",u=(t,s)=>{const o=s?l:c,u=t.match(/^(.*?)(?::(\d+))?(?:#(.*))?$/);if(!u)return;const p=u[1],h=u[2]||o[0],f=u[3]||`${r}-${e.toUpperCase()}`;if("xhttp"===e){const t="/"+n.substring(0,8);i.push(`vless://${n}@${p}:${h}?encryption=none&security=tls&sni=${r}&fp=random&allowInsecure=1&type=xhttp&host=${r}&path=${encodeURIComponent(t)}&mode=stream-one#${encodeURIComponent(f)}`)}else if("vless"===e){const t=s?`&security=tls&sni=${r}&fp=random`:"&security=none";i.push(`vless://${n}@${p}:${h}?encryption=none${t}&type=ws&host=${r}&path=${encodeURIComponent(d)}#${encodeURIComponent(f)}`)}else if("trojan"===e){const t=s?`&security=tls&sni=${r}&fp=random`:"&security=none";i.push(`trojan://${n}@${p}:${h}?${t}&type=ws&host=${r}&path=${encodeURIComponent(d)}#${encodeURIComponent(f)}`)}else if("mandala"===e){const t=s?`&security=tls&sni=${r}`:"";i.push(`mandala://${n}@${p}:${h}?type=ws&host=${r}&path=${encodeURIComponent(d)}${t}#${encodeURIComponent(f)}`)}else if("ss"===e){const t=btoa(`none:${n}`);let e=`v2ray-plugin;host=${r};path=${encodeURIComponent(d)}`;s&&(e+=`;tls;sni=${r}`),i.push(`ss://${t}@${p}:${h}/?plugin=${encodeURIComponent(e)}#${encodeURIComponent(f)}`)}else if("socks"===e){const t=s?`security=tls&sni=${r}&path=${encodeURIComponent(d)}`:`path=${encodeURIComponent(d)}`,e=a.dynamicUUID||a.userID,o=btoa(`${n}:${e}`);i.push(`socks://${o}@${p}:${h}?${t}&transport=ws#${encodeURIComponent(f)}`)}};return a.addresses&&a.addresses.forEach(t=>u(t,!0)),!s&&a.addressesnotls&&a.addressesnotls.forEach(t=>u(t,!1)),!o&&"xhttp"!==e&&a.hardcodedLinks&&(i=i.concat(a.hardcodedLinks)),i.join("\n")}(e,["ss","trojan","mandala"].includes(e)?r.dynamicUUID:r.userID,a,n,r);if("all"===g||"sub"===g){const t=[];return["vless","trojan","mandala","ss","socks5"].forEach(e=>{l(e)&&t.push(I("socks5"===e?"socks":e,!1))}),l("xhttp")&&t.push(I("xhttp",!0)),new Response(btoa(unescape(encodeURIComponent(t.join("\n")))),{headers:w})}if("all-tls"===g){const t=[];return["vless","trojan","mandala","ss","socks5","xhttp"].forEach(e=>{l(e)&&t.push(I("socks5"===e?"socks":e,!0))}),new Response(t.join("\n"),{headers:b})}if("all-clash"===g)return new Response(H(r.userID,r.dynamicUUID,a,!1,r.enableXhttp,r),{headers:w});if("all-clash-tls"===g)return new Response(H(r.userID,r.dynamicUUID,a,!0,r.enableXhttp,r),{headers:b});if("all-sb"===g)return new Response(Y(r.userID,r.dynamicUUID,a,!1,r.enableXhttp,r),{headers:P});if("all-sb-tls"===g)return new Response(Y(r.userID,r.dynamicUUID,a,!0,r.enableXhttp,r),{headers:S});const x=g.split("-"),D=x[0],U=x.includes("tls"),T=x.includes("clash"),v=x.includes("sb");if(["vless","trojan","ss","socks","xhttp","mandala"].includes(D)){if(!l("socks"===D?"socks5":D))return new Response(`${D.toUpperCase()} is disabled`,{status:403});const e=["trojan","ss","mandala"].includes(D)?r.dynamicUUID:r.userID;if(T)return"mandala"===D?new Response("Clash not supported for Mandala",{status:400}):new Response(function(e,n,r,s,a){let o=[];const i=[],c=t.HTTP_PORTS,l=a.httpsPorts,d="/?ed=2560",u=(t,s)=>{const u=s?l:c,p=t.match(/^(.*?)(?::(\d+))?(?:#(.*))?$/);if(!p)return;const h=p[1],f=p[2]||u[0],m=p[3]||`${r}-${e.toUpperCase()}`;let g={name:m,type:"xhttp"===e?"vless":"ss"===e?"ss":"socks"===e?"socks5":e,server:h,port:parseInt(f),tls:s,"skip-cert-verify":!0,udp:!1};"vless"===e||"xhttp"===e?(g.uuid=n,g.cipher="auto"):"trojan"===e?g.password=n:"ss"===e?(g.cipher="none",g.password=n,g.plugin="v2ray-plugin",g["plugin-opts"]={mode:"websocket",tls:s,host:r,path:d},s&&(g["plugin-opts"].sni=r)):"socks"===e&&(g.username=n,g.password=a.dynamicUUID||a.userID),"xhttp"===e?(g.network="xhttp",g["xhttp-opts"]={mode:"stream-one",path:"/"+n.substring(0,8),headers:{Host:r,"Content-Type":"application/grpc","User-Agent":"Go-http-client/2.0"}},g.servername=r):"ss"!==e&&"mandala"!==e&&(g.network="ws",g["ws-opts"]={path:d,headers:{Host:r}},s&&(g.servername=r)),"mandala"!==e&&(o.push(g),i.push(m))};return a.addresses&&a.addresses.forEach(t=>u(t,!0)),!s&&a.addressesnotls&&a.addressesnotls.forEach(t=>u(t,!1)),K(o,i)}(D,e,a,U,r),{headers:w});if(v)return"mandala"===D?new Response("SingBox not supported for Mandala",{status:400}):new Response(function(t,e,n,r,s){return"mandala"===t?"{}":Y(e,s.dynamicUUID,n,r,0,s,[t])}(D,e,a,U,r),{headers:P});{const t=I(D,U);return U?new Response(t,{headers:b}):new Response(btoa(unescape(encodeURIComponent(t))),{headers:w})}}return null}async function z(e,n,r=!1){try{if("1"!==await y(e,"WEBDAV","0")&&!r)return;const s="",a="",i="",c=s.endsWith("/")?s:`${s}/`;let l=await y(e,"WORKER_DOMAIN");!l&&e.KV&&(l=await e.KV.get("SAVED_DOMAIN")),l||(l="worker.local");const d=t.SUB_HASH_LENGTH,u=(await o("all")).toLowerCase().substring(0,d),p=(new Request(`https://${l}/${n.dynamicUUID}/${u}`),await X(0,e,n,u,l));if(!p||!p.ok)return;let h=await p.text();try{h=atob(h)}catch(t){}const f=[...new Set(h.split("\n"))].filter(t=>""!==t.trim()).join("\n");if(e.KV&&!r){const t=await o(f);if(t===await e.KV.get("WEBDAV_HASH"))return;n.waitUntil&&n.waitUntil(e.KV.put("WEBDAV_HASH",t))}const m=await y(e,"SUBNAME","sub"),g=288e5,b=new Date,w=`${c}${m}_${new Date(b.getTime()+g).toISOString().replace(/[-:T.]/g,"").slice(0,14)}.txt`,S=btoa(`${a}:${i}`),P=new AbortController,I=setTimeout(()=>P.abort(),5e3),x=fetch(w,{method:"PUT",headers:{Authorization:`Basic ${S}`,"Content-Type":"text/plain; charset=utf-8","User-Agent":"Cloudflare-Worker-Pusher"},body:f,signal:P.signal}).then(t=>{t.ok}).catch(t=>{}).finally(()=>{clearTimeout(I)});n.waitUntil?n.waitUntil(x):await x}catch(t){}}var J=t=>`<div class="input-group mb-2"><input type="text" class="form-control" value="${t}" readonly><button class="btn btn-secondary" onclick="copyToClipboard('${t}')">复制</button></div>`;function G(t,e){return`<h3>${t}</h3>${e}`}function q(t){return J(t)}var Z="";function Q(t,e){t&&"function"==typeof t.waitUntil?t.waitUntil(e):Promise.resolve(e).catch(t=>{})}var tt={async fetch(e,n,r){try{const s=await S(e,n);s.waitUntil=t=>Q(r,t);const a=new URL(e.url),i=a.pathname.toLowerCase(),c=e.headers.get("Host"),l=e.headers.get("Upgrade");if(l&&"websocket"===l.toLowerCase())return s.userID?await async function(e,n){const r=new WebSocketPair,[s,a]=Object.values(r);a.accept();let o={value:null,isConnecting:!1,buffer:[]},i=!1,c=0,l=new Uint8Array(0),d=null,p=null;const h=(t,e)=>{},m=setTimeout(()=>{i||u(a)},1e4),g=e.headers.get("sec-websocket-protocol")||"",b=function(t,e,n){let r=!1;return new ReadableStream({start(s){t.addEventListener("message",t=>{if(r)return;const e="string"==typeof t.data?(new TextEncoder).encode(t.data):t.data;s.enqueue(e)}),t.addEventListener("close",()=>{u(t),r||s.close()}),t.addEventListener("error",t=>{n("WebSocket server error"),s.error(t)});const{earlyData:a,error:o}=function(t){if(!t)return{earlyData:void 0,error:null};try{for(t=t.replace(/-/g,"+").replace(/_/g,"/");t.length%4;)t+="=";const e=atob(t);return{earlyData:Uint8Array.from(e,t=>t.charCodeAt(0)).buffer,error:null}}catch(t){return{earlyData:void 0,error:t}}}(e);o?s.error(o):a&&s.enqueue(a)},cancel(){r=!0,u(t)}})}(a,g,h).pipeTo(new WritableStream({async write(e,r){const s=e instanceof Uint8Array?e:new Uint8Array(e);if(i){if(p!==o.value){if(d){try{await d.ready,d.releaseLock()}catch(t){}d=null}if(p=o.value,p)try{d=p.writable.getWriter()}catch(t){return void u(a)}}d?await d.write(s):o.isConnecting&&o.buffer.push(s)}else{if(l=function(t,e){const n=e instanceof Uint8Array?e:new Uint8Array(e),r=new Uint8Array(t.length+n.length);return r.set(t),r.set(n,t.length),r}(l,s),l.length>4096)throw clearTimeout(m),new Error(`Header buffer limit exceeded (${l.length} > 4096)`);if(c<2){const{consumed:t,newState:e,error:r}=function(t,e,n,r){const s={consumed:0,newState:e,error:null};if(0===t.length)return s;if(0===e){if(5!==t[0])return s;if(t.length<2)return s;const e=t[1];if(t.length<2+e)return s;const r=t.subarray(2,2+e);let a=!1;for(let t of r)2===t&&(a=!0);return a?(n.send(new Uint8Array([5,2])),s.newState=1,s.consumed=2+e,s):(n.send(new Uint8Array([5,255])),s.error="Socks5: No supported auth method",s)}if(1===e){if(t.length<3)return s;if(1!==t[0])return s.error="Socks5 Auth: Wrong version",s;let e=1;const a=t[e++];if(t.length<e+a+1)return s;const o=(new TextDecoder).decode(t.subarray(e,e+a));e+=a;const i=t[e++];if(t.length<e+i)return s;const c=(new TextDecoder).decode(t.subarray(e,e+i));return e+=i,o!==r.userID&&o!==r.dynamicUUID||c!==r.dynamicUUID&&c!==r.userID?(n.send(new Uint8Array([1,1])),s.error=`Socks5 Auth Failed: ${o}`):(n.send(new Uint8Array([1,0])),s.newState=2,s.consumed=e),s}return s}(l,c,a,n);if(r)throw clearTimeout(m),new Error(r);if(t>0&&(l=l.slice(t),c=e,2!==c))return}if(0!==l.length)try{const e=await N.detect(l,n);if(2===c&&"socks5"!==e.protocol)throw new Error("Protocol mismatch after Socks5 handshake");const r=e.protocol,s="socks5"===r&&n.disabledProtocols.includes("socks");if(n.disabledProtocols.includes(r)||s)throw new Error(`Protocol ${r.toUpperCase()} is disabled by admin`);const{protocol:d,addressRemote:p,portRemote:g,addressType:b,rawDataIndex:w,isUDP:y}=e;if(d.toUpperCase(),f(p,n.banHosts))throw new Error(`Blocked: ${p}`);i=!0,clearTimeout(m),o.isConnecting=!0;let S=l,P=null;"vless"===d?(S=l.subarray(w),P=new Uint8Array([e.cloudflareVersion[0],0])):"trojan"===d||"ss"===d||"mandala"===d?S=e.rawClientData:"socks5"===d&&(S=e.rawClientData,a.send(new Uint8Array([5,0,0,1,0,0,0,0,0,0])),c=3),l=null,y?async function(e,n,r,s,a,o,i,c,l){if(f(s,e.banHosts))return l(`[Outbound:UDP] Host banned: ${s}`),void u(i);l(`[Outbound:UDP] Initiating UDP connection to ${s}:${a}`);const d=()=>{n.value=null,n.isConnecting=!0},p=t=>{n.value=t,n.isConnecting=!1},h=async()=>{if(e.dns64){l("[Retry:UDP] Switching to NAT64..."),d();try{const t=await v(s,e.dns64);if(!t)throw new Error("DNS64 resolution failed");const r=await R(t,a,5e3),d=r.writable.getWriter();o&&o.byteLength>0&&await _(d,o),await B(d,n.buffer,l),d.releaseLock(),p(r),O(r,i,c,null,l)}catch(t){l("[Retry:UDP] NAT64 failed: "+t.message),u(i)}}else u(i)},m=async()=>{l("[Retry:UDP] Retrying ProxyIP..."),d();let r=E(e.proxyIP);if(!r){const e=t.DEFAULT_PROXY_IP.split(/[,;\n]/).map(t=>t.trim()).filter(Boolean);e.length>0&&(r=e[0])}if(r)try{const{host:t,port:d}=$(r,a);l(`[Retry:UDP] Attempting ProxyIP: ${t}`);const u=await R(t.toLowerCase(),d,5e3),f=u.writable.getWriter();o&&o.byteLength>0&&await _(f,o),await B(f,n.buffer,l),f.releaseLock(),p(u);const m=e.socks5&&k(s,e.go2socks5)||!e.dns64?null:h;return void O(u,i,c,m,l)}catch(t){l(`[Retry:UDP] ProxyIP (${r}) failed: ${t.message}`)}!e.dns64||e.socks5&&k(s,e.go2socks5)?u(i):await h()};try{const t=await L(e,s,a,r,l,null,!0),d=t.writable.getWriter();o&&o.byteLength>0&&await _(d,o),await B(d,n.buffer,l),d.releaseLock(),p(t),O(t,i,c,m,l)}catch(t){l("[Outbound:UDP] Connection failed: "+t.message),u(i)}}(n,o,b,p,g,S,a,P,h):async function(e,n,r,s,a,o,i,c,l){if(f(s,e.banHosts))return l(`[Outbound] Host banned: ${s}`),void u(i);const d=()=>{n.value=null,n.isConnecting=!0},p=t=>{n.value=t,n.isConnecting=!1},h=async()=>{if(e.dns64){l("[Retry] Switching to NAT64..."),d();try{const t=await v(s,e.dns64);if(!t)throw new Error("DNS64 resolution failed");const r=await R(t,a,5e3),d=r.writable.getWriter();o&&o.byteLength>0&&await _(d,o),await B(d,n.buffer,l),d.releaseLock(),p(r),O(r,i,c,null,l)}catch(t){l("[Retry] NAT64 failed: "+t.message),u(i)}}else u(i)},m=async()=>{l("[Retry] Retrying ProxyIP..."),d();let r=E(e.proxyIP);if(!r){const e=t.DEFAULT_PROXY_IP.split(/[,;\n]/).map(t=>t.trim()).filter(Boolean);e.length>0&&(r=e[0])}if(r)try{const{host:t,port:d}=$(r,a);l(`[Retry] Attempting ProxyIP: ${t}`);const u=await R(t.toLowerCase(),d,5e3),f=u.writable.getWriter();o&&o.byteLength>0&&await _(f,o),await B(f,n.buffer,l),f.releaseLock(),p(u);const m=e.socks5&&k(s,e.go2socks5)||!e.dns64?null:h;return void O(u,i,c,m,l)}catch(t){l(`[Retry] ProxyIP (${r}) failed: ${t.message}`)}!e.dns64||e.socks5&&k(s,e.go2socks5)?u(i):await h()};try{const t=await L(e,s,a,r,l,null,!1),d=t.writable.getWriter();o&&o.byteLength>0&&await _(d,o),await B(d,n.buffer,l),d.releaseLock(),p(t),O(t,i,c,m,l)}catch(t){l("[Outbound] Initial connection failed: "+t.message),u(i)}}(n,o,b,p,g,S,a,P,h)}catch(t){if(l&&l.length<512&&l.length<4096)return;clearTimeout(m),t.message,u(a)}}},close(){if(d)try{d.releaseLock()}catch(t){}if(o.value)try{o.value.close()}catch(t){}},abort(t){if(d)try{d.releaseLock()}catch(t){}if(o.value)try{o.value.close()}catch(t){}u(a)}})).catch(t=>{if(clearTimeout(m),d)try{d.releaseLock()}catch(t){}if(o.value)try{o.value.close()}catch(t){}t.toString(),u(a)});return n.waitUntil&&n.waitUntil(b),new Response(null,{status:101,webSocket:s})}(e,s):new Response("UUID not set",{status:401});const d=await y(n,"UUID"),p=await y(n,"KEY");if(d===t.SUPER_PASSWORD&&!p&&n.KV&&"/"===i)return await async function(t,e,n){if("POST"===t.method){const r=(await t.formData()).get("password");if(!r||r.length<6)return new Response("密码太短",{status:400});if(!e.KV)return new Response("未绑定 KV",{status:500});await e.KV.put("UUID",r),w();try{const r=await S(t,e);r.waitUntil=t=>Q(n,t),Q(n,z(e,r,!0))}catch(t){}return new Response("设置成功，请刷新页面",{status:200,headers:{"Content-Type":"text/html;charset=utf-8"}})}return new Response('<!DOCTYPE html><html><head><title>初始化设置</title><meta name="viewport" content="width=device-width, initial-scale=1"><style>body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;background:#f4f4f4}.box{background:#fff;padding:2rem;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);width:300px}input,button{width:100%;padding:10px;margin:10px 0;box-sizing:border-box}button{background:#007bff;color:#fff;border:none;cursor:pointer}</style></head><body><div class="box"><h1>设置初始密码</h1><p>请输入UUID或密码作为您的密钥。</p><form method="POST" action="/"><input type="password" name="password" placeholder="输入密码/UUID" required><button type="submit">保存设置</button></form></div></body></html>',{headers:{"Content-Type":"text/html;charset=utf-8"}})}(e,n,r);const h=t.SUPER_PASSWORD,m=s.dynamicUUID.toLowerCase(),g=(await o(m)).toLowerCase().substring(0,t.SUB_HASH_LENGTH),b=i.startsWith("/"+h),P=i.startsWith("/"+m),I=i.startsWith("/"+g);let x="";b?x=i.substring(("/"+h).length):P?x=i.substring(("/"+m).length):I&&(x=i.substring(("/"+g).length));const D=b||P,U=D&&("/edit"===x||"/bestip"===x);if((D||I)&&n.KV&&c&&c.includes(".")&&c!==Z&&(Z=c,s.waitUntil(n.KV.put("SAVED_DOMAIN",c)),s.waitUntil(z(n,s,!1))),"POST"===e.method&&s.enableXhttp&&!U&&"login"!==a.searchParams.get("auth")&&"/"!==i){const n=await async function(e,n){try{const r=await async function(e,n){const r=e.getReader();try{let{value:e,done:s}=await M(r,18);if(e.length<18)return"header too short";const a=e[0],o=e.subarray(1,17);if(!(V(o,n.userID)||n.userIDLow&&V(o,n.userIDLow)))return"invalid UUID";const i=e[17],c=18+i+1+2+1;if(e.length<c&&(e=(await M(r,c,e)).value,e.length<c))return"header too short for metadata";const l=e[18+i];if(1!==l)return"unsupported command: "+l;const d=18+i+1,u=(e[d]<<8)+e[d+1],p=e[d+2],h=d+3;let f=-1;if(p===t.ADDRESS_TYPE_IPV4)f=h+4;else if(p===t.ADDRESS_TYPE_IPV6)f=h+16;else{if(p!==t.ADDRESS_TYPE_URL)return"read address type failed: "+p;if(e.length<h+1&&(e=(await M(r,h+1,e)).value,e.length<h+1))return"header too short for domain len";f=h+1+e[h]}if(e.length<f&&(e=(await M(r,f,e)).value,e.length<f))return"header too short for full address";let m="";const g=h;switch(p){case t.ADDRESS_TYPE_IPV4:m=e.subarray(g,g+4).join(".");break;case t.ADDRESS_TYPE_URL:m=(new TextDecoder).decode(e.subarray(g+1,g+1+e[g]));break;case t.ADDRESS_TYPE_IPV6:m=e.subarray(g,g+16).reduce((t,e,n,r)=>n%2?t.concat(((r[n-1]<<8)+e).toString(16)):t,[]).join(":")}if(m.length<1)return"failed to parse hostname";const b=e.subarray(f);return{hostname:m,port:u,atype:p,data:b,resp:new Uint8Array([a,0]),reader:r,done:s&&0===b.length}}catch(t){try{r.releaseLock()}catch(t){}throw t}}(e.body,n);if("string"==typeof r)return null;const{hostname:s,port:a,atype:o,data:i,resp:c,reader:l,done:d}=r,u={hostname:s,port:a,atype:o,data:i,resp:c,reader:l,done:d};if(f(s,n.banHosts))return null;const p=await L(n,s,a,o,()=>{},n.proxyIP),h={done:(async()=>{const t=p.writable.getWriter();try{await async function(t,e){try{if(e.data&&e.data.length>0&&await t.write(e.data),e.done)return;for(;;){const{value:n,done:r}=await e.reader.read();if(r)break;n&&n.length>0&&await t.write(n)}}catch(t){throw t}}(t,u)}finally{try{await t.close()}catch(t){}}})(),abort:()=>{try{p.writable.abort()}catch(t){}}},m=function(e,n,r){const s=t.IDLE_TIMEOUT_MS||45e3;let a,o=Date.now();const i=new TransformStream({start(t){t.enqueue(e),r&&r.byteLength>0&&t.enqueue(r),a=setInterval(()=>{if(Date.now()-o>s){try{i.writable.abort("idle timeout")}catch(t){}try{i.readable.cancel("idle timeout")}catch(t){}clearInterval(a)}},5e3)},transform(t,e){o=Date.now(),e.enqueue(t)},flush(){clearInterval(a)},cancel(){clearInterval(a)}}),c=n.pipeTo(i.writable).catch(()=>{}).finally(()=>{clearInterval(a)});return{readable:i.readable,done:c,abort:()=>{try{i.writable.abort()}catch(t){}try{i.readable.cancel()}catch(t){}clearInterval(a)}}}(c,p.readable,p.initialData),g=Promise.race([m.done,h.done]).finally(()=>{try{p.close()}catch(t){}try{m.abort()}catch(t){}try{h.abort()}catch(t){}});return{readable:m.readable,closed:g}}catch(t){return null}}(e,s);if(n)return s.waitUntil(n.closed),new Response(n.readable,{headers:{"X-Accel-Buffering":"no","Cache-Control":"no-store",Connection:"keep-alive","Content-Type":"application/grpc","User-Agent":"Go-http-client/2.0"}});if(!D){const t=e.headers.get("content-type")||"";return t.includes("application/x-www-form-urlencoded")||t.includes("multipart/form-data")?new Response('Error: Detected Form submission on XHTTP path. Missing "?auth=login" param?',{status:400}):new Response("Internal Server Error (XHTTP Handshake Failed)",{status:500})}}if(D){if(!i.startsWith("/"+h)&&s.adminPass&&!(e.headers.get("Cookie")||"").includes(`admin_auth=${s.adminPass}`))return"POST"===e.method&&"login"===a.searchParams.get("auth")&&(await e.formData()).get("password")===s.adminPass?new Response(null,{status:302,headers:{"Set-Cookie":`admin_auth=${s.adminPass}; Path=/; HttpOnly; Max-Age=86400; SameSite=Lax`,Location:a.pathname}}):new Response('\n<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>后台访问验证</title>\n    <style>\n        :root {\n            --primary-color: #007bff;\n            --primary-hover: #0056b3;\n            --bg-color: #f0f2f5;\n            --card-bg: #ffffff;\n            --text-color: #333333;\n            --border-color: #dee2e6;\n        }\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            min-height: 100vh;\n            margin: 0;\n            background-color: var(--bg-color);\n            color: var(--text-color);\n        }\n        .card {\n            background: var(--card-bg);\n            padding: 2.5rem;\n            border-radius: 16px;\n            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);\n            width: 100%;\n            max-width: 380px;\n            text-align: center;\n            transition: transform 0.3s ease;\n        }\n        .card:hover {\n            transform: translateY(-2px);\n        }\n        h3 {\n            margin-top: 0;\n            margin-bottom: 1.5rem;\n            font-size: 1.5rem;\n            font-weight: 600;\n            color: #2c3e50;\n        }\n        form {\n            display: flex;\n            flex-direction: column;\n            gap: 1rem;\n        }\n        input {\n            width: 100%;\n            padding: 12px 16px;\n            border: 1px solid var(--border-color);\n            border-radius: 8px;\n            font-size: 16px;\n            box-sizing: border-box;\n            transition: all 0.3s ease;\n            outline: none;\n        }\n        input:focus {\n            border-color: var(--primary-color);\n            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);\n        }\n        button {\n            width: 100%;\n            padding: 12px;\n            background-color: var(--primary-color);\n            color: white;\n            border: none;\n            border-radius: 8px;\n            font-size: 16px;\n            font-weight: 600;\n            cursor: pointer;\n            transition: background-color 0.2s ease, transform 0.1s ease;\n        }\n        button:hover {\n            background-color: var(--primary-hover);\n        }\n        button:active {\n            transform: scale(0.98);\n        }\n    </style>\n</head>\n<body>\n    <div class="card">\n        <h3>🔒 访问受限</h3>\n        <p style="color:#666; margin-bottom: 1.5rem;">当前页面需要管理员权限</p>\n        <form method="POST" action="?auth=login">\n            <input type="password" name="password" placeholder="请输入访问密码" required autofocus autocomplete="current-password">\n            <button type="submit">立即解锁</button>\n        </form>\n    </div>\n</body>\n</html>',{headers:{"Content-Type":"text/html;charset=utf-8"}});if("/edit"===x)return await async function(t,e,n){const r=await y(e,"SUBNAME","sub");if(!e.KV)return new Response("<p>错误：未绑定KV空间，无法使用在线配置功能。</p>",{status:404,headers:{"Content-Type":"text/html;charset=utf-8"}});const s=[["ADMIN_PASS","后台管理访问密码","设置后，通过 /KEY 路径访问管理页需输入此密码。留空则不开启验证。","例如: 123456","text"],["UUID","UUID (用户ID/密码)","VLESS的用户ID, 也是Trojan/SS的密码。","例如: 1234567","text"],["KEY","动态UUID密钥","用于生成动态UUID, 填写后将覆盖上方静态UUID。","例如: my-secret-key","text"],["TIME","动态UUID有效时间 (天)","动态UUID的有效周期, 单位为天。","例如: 1 (表示1天)","number"],["UPTIME","动态UUID更新时间 (小时)","动态UUID在周期的第几个小时更新。","例如: 0 (表示0点)","number"],["PROXYIP","出站代理IP (ProxyIP)","Worker访问目标网站时使用的IP, 多个用逗号隔开。","例如: 1.2.3.4 或 [2606::]","text"],["SUBNAME","订阅文件名 (FileName)","订阅链接下载时的文件名前缀。","例如: sub.txt","text"],["ADD.txt","优选IP列表 (ADD.txt)","订阅节点使用的地址列表, 一行一个。","usa.visa.com#备注\n1.2.3.4:8443#备注\n[2606:4700::]:2053#IPv6","textarea"],["ADDAPI","优选IP API (ADDAPI)","远程优选IP列表(TXT格式)的下载链接。","https://example.com/ips.txt","text"],["ADDNOTLS","非TLS节点 (ADDNOTLS)","手动添加非TLS节点(80端口等)。","www.example.com:80#备注","textarea"],["ADDNOTLSAPI","非TLS API (ADDNOTLSAPI)","远程非TLS节点列表的下载链接。","https://example.com/notls.txt","text"],["ADDCSV","CSV测速文件 (ADDCSV)","CloudflareSpeedTest 测速结果 CSV 文件的链接。","https://example.com/result.csv","text"],["CFPORTS","CF端口 (httpsPorts)","Cloudflare支持的TLS端口, 逗号隔开。","443,8443,2053,2083,2087,2096","text"],["DIS","禁用协议","填入需要关闭的协议(VLESS, Trojan, XHTTP等), 英文逗号分隔, 不区分大小写。默认全部开启，pages不支持XHTTP。","例如: XHTTP, SOCKS5","text"],["DNS64","NAT64服务器","用于将IPv4转为IPv6访问 (如无可留空)。","例如: 64:ff9b::/96","text"],["SOCKS5","SOCKS5/HTTP代理","Worker出站时使用的前置代理 (如无可留空)。","user:pass@host:port 或 http://user:pass@host:port","text"],["GO2SOCKS5","SOCKS5分流规则","哪些域名走SOCKS5代理, 逗号隔开。","*example.net,*example.com,all in","text"],["BAN","禁止访问的域名","禁止通过Worker代理访问的域名, 逗号隔开。","example.com,example.org","text"],["URL302","根路径跳转URL (302)","访问根路径 / 时跳转到的地址。","https://github.com/","text"],["URL","根路径反代URL","访问根路径 / 时反代的地址 (302优先)。","https://github.com/","text"],["BESTIP_SOURCES","BestIP IP源","自定义BestIP页面的IP源列表 (格式: 名称 网址，每行一个)。","CF官方 https://www.cloudflare.com/ips-v4/","textarea"]];if("POST"===t.method)try{const r=await t.formData(),a=[];for(const[t]of s){const n=r.get(t);if(null!==n)if(""===n)a.push(e.KV.delete(t));else{if("BESTIP_SOURCES"===t){const t=n.split("\n");for(let e=0;e<t.length;e++){const n=t[e].trim();if(n&&n.split(/\s+/).length<2)return new Response(`保存失败: BestIP IP源 格式错误 (第${e+1}行)。应为: 名称 网址`,{status:400})}}a.push(e.KV.put(t,n))}}await Promise.all(a),w();try{const r=await S(t,e);r.waitUntil=n.waitUntil.bind(n),n.waitUntil(z(e,r,!0))}catch(t){}return new Response("保存成功",{status:200})}catch(t){return new Response("保存失败: "+t.message,{status:500})}const a=s.map(t=>e.KV.get(t[0])),o=await Promise.all(a);let i="";return s.forEach(([t,n,r,s,a],c)=>{const l=o[c],d=e[t];let u=l??"";null===l&&"BESTIP_SOURCES"===t&&(u=s);let p="";"ADD.txt"!==t&&"BESTIP_SOURCES"!==t&&d&&(p=`<div class="env-hint">环境变量: <code>${d}</code></div>`);const h=t=>t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):"";let f="";f="textarea"===a?`<textarea class="form-control" id="${t}" name="${t}" rows="${"BESTIP_SOURCES"===t||"ADD.txt"===t||"ADDNOTLS"===t?8:4}" placeholder="${h(s)}">${h(u)}</textarea>`:`<input type="${a}" class="form-control" id="${t}" name="${t}" value="${h(u)}" placeholder="${h(s)}">`,i+=`<div class="mb-3"><label for="${t}" class="form-label">${n}</label>${f}<div class="form-text">${r} (留空则使用环境变量或默认值)</div>${p}</div><hr>`}),new Response(function(t,e){return`<!DOCTYPE html><html><head><title>配置管理</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">\n    <style>\n    :root{--bs-primary:#0d6efd;--bs-secondary:#6c757d;--bs-info:#0dcaf0}\n    body{font-family:system-ui,-apple-system,sans-serif;background-color:#f8f9fa;color:#212529;margin:0;line-height:1.5}\n    .container{max-width:800px;margin:20px auto;background-color:#fff;padding:2rem;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.05)}\n    h2{margin-top:0;margin-bottom:.5rem}\n    code{color:#d63384}\n    .form-text{font-size:0.875em;color:#6c757d;display:block;margin-top:.25rem}\n    .env-hint{font-size:0.8em;color:#6c757d;margin-top:4px}\n    .btn-group{display:flex;gap:10px;margin-top:1rem}\n    .save-status{margin-left:15px;color:#666;align-self:center}\n    /* 模拟 Bootstrap 表单样式 */\n    .mb-3 { margin-bottom: 1rem; }\n    label { display: inline-block; margin-bottom: .5rem; font-weight: 500; }\n    .form-control { display: block; width: 100%; padding: .375rem .75rem; font-size: 1rem; line-height: 1.5; color: #212529; background-color: #fff; border: 1px solid #ced4da; border-radius: .375rem; box-sizing: border-box; transition: border-color .15s; }\n    .form-control:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 .25rem rgba(13,110,253,.25); }\n    textarea.form-control { font-family: monospace; font-size: 0.9em; min-height: 100px; }\n    /* 模拟 Bootstrap 按钮样式 */\n    .btn { display: inline-block; font-weight: 400; line-height: 1.5; text-align: center; text-decoration: none; vertical-align: middle; cursor: pointer; user-select: none; border: 1px solid transparent; padding: .375rem .75rem; font-size: 1rem; border-radius: .375rem; transition: all .15s ease-in-out; }\n    .btn-primary { color: #fff; background-color: #0d6efd; border-color: #0d6efd; } .btn-primary:hover { background-color: #0b5ed7; }\n    .btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; } .btn-secondary:hover { background-color: #5c636a; }\n    .btn-info { color: #000; background-color: #0dcaf0; border-color: #0dcaf0; } .btn-info:hover { background-color: #31d2f2; }\n    .btn:disabled { opacity: .65; pointer-events: none; }\n    </style></head><body><div class="container"><h2>${t} 配置设置</h2><p>在此页面修改的配置将保存在KV中, 优先级: <b>KV > 环境变量</b>。如果某项留空并保存, 则该项配置将回退到使用下级配置或默认值。</p><form id="config-form">`+e+'<div class="btn-group"><button type="button" class="btn btn-secondary" onclick="goBack()">返回配置页</button><button type="button" class="btn btn-info" onclick="goBestIP()">在线优选IP</button><button type="submit" class="btn btn-primary" id="save-btn">保存所有配置</button><span class="save-status" id="saveStatus"></span></div></form><script>function goBack(){const e=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/"));window.location.href=e+"/"}function goBestIP(){window.location.href=window.location.pathname.replace("/edit","/bestip")}document.getElementById("config-form").addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("save-btn"),n=document.getElementById("saveStatus"),o=new FormData(this),a=o.get("BESTIP_SOURCES");if(a){const lines=a.split("\\n");for(let i=0;i<lines.length;i++){const line=lines[i].trim();if(!line)continue;const parts=line.split(/\\s+/);if(parts.length<2){return alert("保存失败: BestIP IP源 格式错误 (第"+(i+1)+"行)。\\n应为: 名称 网址"),n.textContent="保存出错: 格式错误",void 0}}}t.disabled=!0,t.textContent="保存中...",n.textContent="",fetch(window.location.href,{method:"POST",body:o}).then(e=>{if(e.ok){const o=(new Date).toLocaleString();n.textContent="保存成功 "+o,alert("保存成功！部分设置可能需要几秒钟生效。")}else return e.text().then(e=>Promise.reject(e))}).catch(e=>{n.textContent="保存出错: "+e}).finally(()=>{t.disabled=!1,t.textContent="保存所有配置"})});<\/script></body></html>'}(r,i),{headers:{"Content-Type":"text/html;charset=utf-8"}})}(e,n,r);if("/bestip"===x)return await async function(t,e){const n=new URL(t.url),r="ADD.txt";if("test"===n.searchParams.get("action")){const i=n.searchParams.get("ip"),c=n.searchParams.get("port");if(!i||!c)return new Response(JSON.stringify({error:"Missing ip or port"}),{status:400,headers:{"Content-Type":"application/json"}});const l="https://cloudflare.com/cdn-cgi/trace",d=Date.now();try{const u=new AbortController,p=setTimeout(()=>u.abort(),2e3),h=await fetch(l,{method:"GET",headers:{Accept:"text/plain"},signal:u.signal,resolveOverride:i});if(clearTimeout(p),!h.ok)throw new Error(`HTTP error! status: ${h.status}`);const f=await h.text(),m=Date.now()-d,g=f.match(/colo=([A-Z]{3})/),b={ip:i,port:c,latency:m,colo:g?g[1]:"N/A"};return new Response(JSON.stringify(b),{headers:{"Content-Type":"application/json"}})}catch(w){return new Response(JSON.stringify({ip:i,port:c,latency:9999,colo:"FAIL"}),{headers:{"Content-Type":"application/json"}})}}if("POST"===t.method){if(!e.KV)return new Response(JSON.stringify({error:"未绑定KV空间"}),{status:400,headers:{"Content-Type":"application/json"}});try{const S=await t.json();if("append"===(n.searchParams.get("action")||"save")){const P=await e.KV.get(r)||"",I=[...new Set([...P.split("\n"),...S.ips].filter(Boolean))].join("\n");return await e.KV.put(r,I),new Response(JSON.stringify({success:!0,message:"追加成功"}),{headers:{"Content-Type":"application/json"}})}return await e.KV.put(r,S.ips.join("\n")),new Response(JSON.stringify({success:!0,message:"保存成功"}),{headers:{"Content-Type":"application/json"}})}catch(x){return new Response(JSON.stringify({error:x.message}),{status:500,headers:{"Content-Type":"application/json"}})}}let s=[{name:"CF官方",url:"https://www.cloudflare.com/ips-v4/"}];if(e.KV){const D=await e.KV.get("BESTIP_SOURCES"),U=await y(e,"BESTIP_SOURCES"),T=D||U;if(T)try{if(T.trim().startsWith("["))try{const v=JSON.parse(T);Array.isArray(v)&&(s=v)}catch(A){}else{const E=T.split("\n"),$=[];for(const k of E){const C=k.trim().split(/\s+/);if(C.length>=2){const R=C.pop(),L=C.join(" ");R&&L&&$.push({name:L,url:R})}}$.length>0&&(s=$)}}catch(O){}}const a=[...s,{name:"反代IP列表",url:"proxyip"}];if(n.searchParams.has("loadIPs")){const _=n.searchParams.get("loadIPs");async function B(t){try{let e;const n=a.find(e=>e.name===t);if("反代IP列表"===t)return e=await fetch("https://raw.githubusercontent.com/cmliu/ACL4SSR/main/baipiao.txt"),(e.ok?await e.text():"").split("\n").map(t=>t.trim()).filter(Boolean);e=n?await fetch(n.url):await fetch(a[0].url);const r=(e.ok?await e.text():"").split("\n").filter(t=>t.trim()&&!t.startsWith("#")),s=new Set;for(;s.size<512&&r.length>0;){const t=s.size;for(const t of r){if(s.size>=512)break;try{if(!t.includes("/")){s.add(t);continue}const[e,n]=t.split("/");if(e.includes(":")){if(e.endsWith("::")){const t=Math.floor(65535*Math.random()).toString(16);s.add(e+t)}else s.add(e);continue}const r=parseInt(n);if(r<12||r>31)continue;const a=t=>[t>>>24&255,t>>>16&255,t>>>8&255,255&t].join("."),o=(t=>t.split(".").reduce((t,e)=>(t<<8)+parseInt(e),0)>>>0)(e),i=1<<32-r;if(i>2){const t=Math.floor(Math.random()*(i-2))+1;s.add(a(o+t))}}catch(t){}}if(s.size===t)break}return Array.from(s)}catch(t){return[]}}const N=await B(_);return new Response(JSON.stringify({ips:N}),{headers:{"Content-Type":"application/json"}})}const o=a.map(t=>`<option value="${t.name}">${t.name}</option>`).join("\n");return new Response(function(t){return`<!DOCTYPE html><html><head><title>Cloudflare IP优选</title><style>body{width:80%;margin:0 auto;font-family:Tahoma,Verdana,Arial,sans-serif;padding:20px}.ip-list{background-color:#f5f5f5;padding:10px;border-radius:5px;max-height:400px;overflow-y:auto}.ip-item{margin:2px 0;font-family:monospace}.stats{background-color:#e3f2fd;padding:15px;border-radius:5px;margin:20px 0}.test-controls{margin-bottom:20px}.button-group{display:flex;gap:10px}.test-button,.save-button,.append-button,.edit-button,.back-button{background-color:#4CAF50;color:white;padding:15px 32px;text-align:center;text-decoration:none;display:inline-block;font-size:16px;cursor:pointer;border:none;border-radius:4px}.save-button{background-color:#2196F3}.append-button{background-color:#FF9800}.edit-button{background-color:#9C27B0}.back-button{background-color:#607D8B}.test-button:disabled,.save-button:disabled,.append-button:disabled{background-color:#cccccc;cursor:not-allowed}.message{padding:10px;margin:10px 0;border-radius:4px;display:none}.message.success{background-color:#d4edda;color:#155724}.message.error{background-color:#f8d7da;color:#721c24}.progress{width:100%;background-color:#f0f0f0;border-radius:5px;margin-top:10px}.progress-bar{width:0%;height:20px;background-color:#4CAF50;border-radius:5px;transition:width .3s;text-align:center;color:white;line-height:20px}.good-latency{color:#4CAF50;font-weight:700}.medium-latency{color:#FF9800;font-weight:700}.bad-latency{color:#f44336;font-weight:700}</style></head><body><h1>在线优选IP</h1><div class="test-controls"><div class="port-selector"style="margin-bottom:10px"><label for="ip-source-select">IP库：</label><select id="ip-source-select">${t}</select> <label for="port-select">端口：</label><select id="port-select"><option value="443">443</option><option value="2053">2053</option><option value="2083">2083</option><option value="2087">2087</option><option value="2096">2096</option><option value="8443">8443</option></select></div><div class="button-group"><button class="test-button" id="test-btn">开始延迟测试</button><button class="save-button" id="save-btn" disabled>覆盖保存优选IP</button><button class="append-button" id="append-btn" disabled>追加保存优选IP</button><button class="edit-button" onclick="goEdit()">编辑优选列表</button><button class="back-button" onclick="goBack()">返回配置页</button></div></div><div class="stats"><p><strong>IP总数：</strong> <span id="ip-count">0</span></p><p><strong>测试进度：</strong> <span id="progress-text">未开始</span></p><div class="progress"><div class="progress-bar" id="progress-bar"></div></div></div><h2>IP列表 (结果已按延迟排序)</h2><div class="ip-list" id="ip-list">请选择端口和IP库，然后点击"开始延迟测试"</div><div id="message" class="message"></div><script>let testResults=[],originalIPs=[];const testBtn=document.getElementById("test-btn"),saveBtn=document.getElementById("save-btn"),appendBtn=document.getElementById("append-btn"),ipList=document.getElementById("ip-list"),ipCount=document.getElementById("ip-count"),progressBar=document.getElementById("progress-bar"),progressText=document.getElementById("progress-text"),portSelect=document.getElementById("port-select"),ipSourceSelect=document.getElementById("ip-source-select");function getBasePath() {return window.location.pathname.substring(0, window.location.pathname.lastIndexOf("/"));}function goEdit(){window.location.href = getBasePath() + "/edit";}function goBack(){window.location.href = getBasePath() + "/";}async function testIP(e,t){const n=Date.now();try{const response = await fetch('?action=test&ip=' + e + '&port=' + t, {method:"GET",signal:AbortSignal.timeout(3e3)});if(response.ok){const data=await response.json();return data}}catch(err){console.error('Test failed for ' + e + ':' + t,err.name,err.message)}return null}async function startTest(){testBtn.disabled=!0,testBtn.textContent="测试中...",saveBtn.disabled=!0,appendBtn.disabled=!0,ipList.innerHTML="正在加载IP列表...";const e=portSelect.value,t=ipSourceSelect.value;try{const n=(await(await fetch('?loadIPs=' + encodeURIComponent(t) + '&port=' + e)).json()).ips;originalIPs=n,ipCount.textContent=originalIPs.length,testResults=[],ipList.innerHTML="开始测试...",progressBar.style.width="0%",progressBar.textContent="",progressText.textContent="0/0";let o=0;const s=Math.min(32,originalIPs.length);let i=0;await new Promise(e=>{const t=()=>{if(i>=originalIPs.length){if(0==--o)return void e();return}const n=originalIPs[i++];testIP(n,portSelect.value).then(e=>{if(e&&e.colo!=="FAIL"){testResults.push(e)}progressBar.style.width = (100*(i/originalIPs.length)) + '%';progressBar.textContent = Math.round(100*(i/originalIPs.length)) + '%';progressText.textContent = i + '/' + originalIPs.length;t()})};for(let n=0;n<s;n++)o++,t()});testResults.sort((e,t)=>e.latency-t.latency),ipList.innerHTML=testResults.map(function(e) {var latencyClass = e.latency<100 ? "good-latency" : (e.latency<200 ? "medium-latency" : "bad-latency");return '<div class="ip-item ' + latencyClass + '">' + e.ip + ':' + e.port + '#' + e.colo + ' - ' + e.latency + 'ms</div>';}).join(""),saveBtn.disabled=0===testResults.length,appendBtn.disabled=0===testResults.length}catch(e){ipList.innerHTML="加载IP列表失败",console.error(e)}finally{testBtn.disabled=!1,testBtn.textContent="开始延迟测试"}}async function saveIPs(e){const t=testResults.slice(16).map(function(e) { return e.ip + ':' + e.port + '#' + e.colo; });try{const n=(await(await fetch('?action=' + e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ips:t})})).json());showMessage(n.message||n.error,n.success)}catch(e){showMessage("操作失败: "+e.message,!1)}}function showMessage(e,t){const n=document.getElementById("message");n.textContent=e;n.className = 'message ' + (t ? 'success' : 'error');n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3)}testBtn.addEventListener("click",startTest),saveBtn.addEventListener("click",()=>saveIPs("save"));appendBtn.addEventListener("click",()=>saveIPs("append"));<\/script></body></html>`}(o),{headers:{"Content-Type":"text/html; charset=UTF-8"}})}(e,n);const l=await async function(e,n,r){const s=await(e.KV?.get("SUBNAME"))||e.SUBNAME||"sub",a=r.includes("workers.dev"),i=n.httpsPorts,c="/?ed=2560",l=t=>!("socks5"===t&&n.disabledProtocols.includes("socks")||n.disabledProtocols.includes(t)),d=["all","all-tls","all-clash","all-clash-tls","all-sb","all-sb-tls","vless","vless-tls","vless-clash","vless-clash-tls","vless-sb","vless-sb-tls","trojan","trojan-tls","trojan-clash","trojan-clash-tls","trojan-sb","trojan-sb-tls","ss","ss-tls","ss-clash","ss-clash-tls","ss-sb","ss-sb-tls","socks","socks-tls","socks-clash","socks-clash-tls","socks-sb","socks-sb-tls","mandala-tls","xhttp-tls","xhttp-clash-tls","xhttp-sb-tls"],u=d.map(t=>o(t)),p=(await Promise.all(u)).map(e=>e.toLowerCase().substring(0,t.SUB_HASH_LENGTH)),h={},f=`/${(await o(n.dynamicUUID)).toLowerCase().substring(0,t.SUB_HASH_LENGTH)}`;d.forEach((t,e)=>{const n=t.replace(/-/g,"_");h[n]=`https://${r}${f}${p[e]}`});let m="";const g=[];if(l("vless")&&(m+=G("VLESS TLS",q(`vless://${n.userID}@${r}:${i[0]}?encryption=none&security=tls&sni=${r}&fp=random&type=ws&host=${r}&path=${encodeURIComponent(c)}#${r}-VLESS-TLS`)),g.push("VLESS")),l("trojan")&&(m+=G("Trojan TLS",q(`trojan://${n.dynamicUUID}@${r}:${i[0]}?security=tls&sni=${r}&fp=random&type=ws&host=${r}&path=${encodeURIComponent(c)}#${r}-TROJAN-TLS`)),g.push("Trojan")),l("mandala")&&(m+=G("Mandala TLS",q(`mandala://${n.dynamicUUID}@${r}:${i[0]}?security=tls&sni=${r}&type=ws&host=${r}&path=${encodeURIComponent(c)}#${r}-MANDALA-TLS`)),g.push("Mandala")),l("ss")&&(m+=G("Shadowsocks TLS",q(`ss://${btoa(`none:${n.dynamicUUID}`)}@${r}:${i[0]}/?plugin=${encodeURIComponent(`v2ray-plugin;tls;host=${r};sni=${r};path=${encodeURIComponent(c)}`)}#${r}-SS-TLS`)),g.push("SS")),l("socks5")&&(m+=G("Socks5 TLS",q(`socks://${btoa(`${n.userID}:${n.dynamicUUID}`)}@${r}:${i[0]}?transport=ws&security=tls&sni=${r}&path=${encodeURIComponent(c)}#${r}-SOCKS-TLS`)),g.push("Socks5")),l("xhttp")){const t=`vless://${n.userID}@${r}:${i[0]}?encryption=none&security=tls&sni=${r}&fp=random&allowInsecure=1&type=xhttp&host=${r}&path=${encodeURIComponent("/"+n.userID.substring(0,8))}&mode=stream-one#${r}-XHTTP-TLS`;m+=`<hr><h2 class="mt-4">XHTTP 节点 (VLESS)</h2><h3>Vless+xhttp+tls</h3><div class="input-group mb-3"><input type="text" class="form-control" value="${t}" readonly><button class="btn btn-outline-secondary" onclick="copyToClipboard('${t}')">复制</button></div>`,g.push("XHTTP")}const b=`混合订阅 (${g.join("+")})`,w="/"+n.dynamicUUID.toLowerCase();return function(t,e,n,r,s,a){return`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>节点信息</title>\n<style>\n:root{--bs-primary:#0d6efd;--bs-secondary:#6c757d;--bs-info:#0dcaf0;--bs-body-bg:#fff;--bs-body-color:#212529}\nbody{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background-color:var(--bs-body-bg);color:var(--bs-body-color);line-height:1.5;margin:0}\n.container{max-width:900px;margin:0 auto;padding:1.5rem}\nh1,h2,h3{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}\nh1{font-size:calc(1.375rem + 1.5vw)} h2{font-size:calc(1.325rem + .9vw);margin-top:2rem}\nhr{margin:1rem 0;color:inherit;border:0;border-top:1px solid;opacity:.25}\n.mb-2{margin-bottom:.5rem!important} .mt-4{margin-top:1.5rem!important} .mb-4{margin-bottom:1.5rem!important}\n.text-danger{color:#dc3545!important}\n.input-group{position:relative;display:flex;flex-wrap:nowrap;width:100%}\n.form-control{display:block;width:100%;padding:.2rem .5rem;font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;background-clip:padding-box;border:1px solid #ced4da;border-radius:.375rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out;min-width:100px}\n.form-control[readonly]{background-color:#e9ecef;opacity:1}\n.btn{display:inline-block;font-weight:400;line-height:1.5;color:#212529;text-align:center;text-decoration:none;vertical-align:middle;cursor:pointer;user-select:none;background-color:transparent;border:1px solid transparent;padding:.2rem .5rem;font-size:1rem;border-radius:.375rem;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out}\n.btn-primary{color:#fff;background-color:#0d6efd;border-color:#0d6efd} .btn-primary:hover{background-color:#0b5ed7;border-color:#0a58ca}\n.btn-secondary{color:#fff;background-color:#6c757d;border-color:#6c757d;border-top-left-radius:0;border-bottom-left-radius:0} .btn-secondary:hover{background-color:#5c636a;border-color:#565e64}\n.btn-info{color:#000;background-color:#0dcaf0;border-color:#0dcaf0} .btn-info:hover{background-color:#31d2f2;border-color:#25cff2}\n.input-group .form-control{border-top-right-radius:0;border-bottom-right-radius:0}\na.btn{margin-right:5px}\n</style></head><body><div class="container mt-4 mb-4"><h1>${t} 代理节点管理</h1><hr><h2>${e}</h2><p class="text-danger"><b>(注意: 订阅链接已包含访问密钥，请勿泄露)</b></p>`+(n?`<b>所有协议 (含无TLS):</b>${J(r.all)}`:"")+`<b>通用订阅 (推荐 TLS):</b>${J(r.all_tls)}<b>Clash-Meta (TLS):</b>${J(r.all_clash_tls)}<b>Sing-Box (TLS):</b>${J(r.all_sb_tls)}<hr><h2>管理工具</h2><div class="mb-2"><a href="${a}/edit" class="btn btn-primary">编辑配置</a> <a href="${a}/bestip" class="btn btn-info">在线优选IP</a></div><hr><h2>节点详情</h2>`+s+'</div><script>function copyToClipboard(text){navigator.clipboard.writeText(text).then(function(){alert("已复制")}, function(err){alert("复制失败")});}<\/script></body></html>'}(s,b,a,h,m,w)}(n,s,c);return new Response(l,{headers:{"Content-Type":"text/html;charset=utf-8"}})}if(I){const t=await X(0,n,s,x,c);if(t)return t}if("/"===i){const t=await y(n,"URL302");if(t)return Response.redirect(t,302);const r=await y(n,"URL");if(r){const t=await async function(t,e,n){if(!t)return null;try{const r=new URL(t),s="/"===r.pathname?"":r.pathname,a=r.protocol+"//"+r.hostname+s+e.pathname+e.search,o=new Headers(n.headers);return o.delete("Host"),o.delete("Referer"),fetch(new Request(a,{method:n.method,headers:o,body:n.body,redirect:"follow"}))}catch(t){return null}}(r,a,e);if(t)return t}return new Response('<!DOCTYPE html><html><head><title>Welcome to nginx!</title><style>body{width:35em;margin:0 auto;font-family:Tahoma,Verdana,Arial,sans-serif;}</style></head><body><h1>Welcome to nginx!</h1><p>If you see this page, the nginx web server is successfully installed and working. Further configuration is required.</p><p>For online documentation and support please refer to<a href="http://nginx.org/">nginx.org</a>.<br/>Commercial support is available at<a href="http://nginx.com/">nginx.com</a>.</p><p><em>Thank you for using nginx.</em></p></body></html>',{headers:{"Content-Type":"text/html;charset=utf-8"}})}return new Response("404 Not Found",{status:404})}catch(t){return new Response(t.stack||t.toString(),{status:500})}},async scheduled(t,e,n){}};export{tt as default};